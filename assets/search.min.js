document.addEventListener("DOMContentLoaded",async()=>{const searchButton=document.querySelector("#searchBoxButton"),searchInput=document.querySelector("#searchBoxInput"),searchResult=document.querySelector("#searchResult"),searchCount=document.querySelector("#searchCount");function parseLocationSearch(){let locationSearch=location.search,result={};if(""==locationSearch)return result;locationSearch=locationSearch.substr(1);for(let kv of locationSearch.split("&")){if(""==kv)continue;const[k,v]=kv.split("=");result[k]=decodeURI(v)}return result}var fuseOptions={shouldSort:!0,includeMatches:!0,threshold:0,tokenize:!0,location:0,distance:100,maxPatternLength:32,minMatchCharLength:1,keys:[{name:"title",weight:.8},{name:"summary",weight:.5},{name:"tags",weight:.3},{name:"date",weight:.3}]};let fuse=null;async function getFuse(){if(null==fuse){const resp=await fetch("/index.json",{method:"get"}),indexData=await resp.json();console.log(indexData.length),fuse=new Fuse(indexData,fuseOptions)}return fuse}function render(items){return items.map(item=>`<div class="post on-list">\n                <h1 class="post-title"><a href="${(item=item.item).permalink}">${item.title}</a></h1>\n                <div class="post-meta"><span class="post-date">${item.date}</span> <span>#${item.tags}</span></div>\n                <div class="post-content">${item.summary}</div>\n              </div>`).join("")}function updateDOM(html,number){searchResult.innerHTML=html,searchCount.innerHTML=`共查询到 ${number} 篇文章`}async function search(){const searchString=searchInput.value,fuse=await getFuse(),result=fuse.search(searchString),html=render(result);updateDOM(html,result.length)}function doSearch(){const wd=parseLocationSearch().q||"";searchInput.value=wd,wd&&search()}function goSearch(){searchCount.innerHTML="查询中…",searchInput.value!=parseLocationSearch().q&&(history.pushState("","",location.pathname+"?q="+searchInput.value),searchInput.blur(),doSearch())}searchButton.addEventListener("click",goSearch),searchInput.addEventListener("keyup",e=>{"Enter"===e.key&&goSearch()}),doSearch(),window.addEventListener("popstate",doSearch)});